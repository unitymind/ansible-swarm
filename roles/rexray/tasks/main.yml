---
- name: Check if Rexray installed
  stat:
    path: /opt/bin/rexray
  register: rexray_file

- name: Install Rexray
  become: true
  shell: curl -sSL https://dl.bintray.com/emccode/rexray/install | sh
  when: rexray_file.stat.exists == False or reinstall_rexray == True
  register: rexray_installed

- name: Make /etc/rexray directory
  become: true
  file:
    path: /etc/rexray
    state: directory
    mode: 0755

- name: Generate /etc/rexray/config.yml
  become: true
  template:
    src: rexray_config_virtualbox.j2.yml
    dest: /etc/rexray/config.yml
    mode: 0600
  register: rexray_config
  when: rexray_storage_type == "virtualbox"

- name: Generate /etc/rexray/config.yml
  become: true
  template:
    src: rexray_config_digitalocean.j2.yml
    dest: /etc/rexray/config.yml
    mode: 0600
  register: rexray_config
  when: rexray_storage_type == "digitalocean"

- name: Restart if nedeed
  become: true
  systemd:
    name: rexray
    state: restarted
  when: (rexray_config | changed) or (rexray_installed | changed)

- name: Allways ensure that started
  become: true
  systemd:
    name: rexray
    state: started
